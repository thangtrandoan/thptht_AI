<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng ƒê·∫øm Ng∆∞·ªùi</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='badge-styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        .webcam-container {
            border: 1px solid #ccc;
            padding: 10px;
            background-color: white;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
            position: relative; /* Cho overlay canvas */
            width: fit-content; /* ƒê·ªÉ container co l·∫°i theo video */
            margin-left: auto;
            margin-right: auto;
        }
        #webcamFeed {
            max-width: 100%;
            height: auto;
            border: 1px solid black;
            transform: scaleX(-1); /* M·∫∑c ƒë·ªãnh l·∫≠t ngang */
        }
        #overlayCanvas { /* Canvas ƒë·ªÉ v·∫Ω bounding box */
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* ƒê·ªÉ click xuy√™n qua canvas */
            transform: scaleX(-1); /* C≈©ng c·∫ßn l·∫≠t n·∫øu video l·∫≠t */
        }
        #hiddenFrameCanvas { /* Canvas ·∫©n ƒë·ªÉ l·∫•y frame g·ª≠i ƒëi */
            display: none;
        }
        .video-footer {
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
        }
        .left-panel { /* ƒê·∫£m b·∫£o left-panel cƒÉn gi·ªØa n·ªôi dung */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div class="main-layout">
        <div class="left-panel">
            <div class="webcam-container">
                <h3>Camera Tr√¨nh Duy·ªát</h3>
                <div style="position: relative;"> <!-- Wrapper cho video v√† overlay canvas -->
                    <video id="webcamFeed" autoplay playsinline muted></video>
                    <canvas id="overlayCanvas"></canvas> <!-- Canvas ƒë·ªÉ v·∫Ω l√™n tr√™n video -->
                </div>
                <button id="toggleCameraButton" class="btn btn-danger mt-2">
                    <i class="bi bi-camera-video-off-fill"></i> T·∫Øt Camera
                </button>
                <div class="video-footer">Ngu·ªìn camera t·ª´ tr√¨nh duy·ªát c·ªßa b·∫°n</div>
            </div>
            <!-- Kh√¥ng c√≤n hi·ªÉn th·ªã processedFeed t·ª´ backend -->
        </div>

        <div class="right-panel">
            <!-- Tab 1: Hi·ªán t·∫°i -->
            <div id="current" class="tab-content active">
                <div class="list">
                    <h1>H·ªçc sinh tr√™n xe</h1>
                    <input type="text" class="search-box" placeholder="T√¨m ng∆∞·ªùi...">
                    <div class="tracked-section">
                        <ul id="trackedObjectsList" class="tracked-list">
                            <li>ƒêang t·∫£i d·ªØ li·ªáu h·ªçc sinh tr√™n xe...</li>
                        </ul>
                    </div>
                    <div class="count-display">
                        üë§ S·ªë HS tr√™n xe: <span id="netCountDisplay">0</span>
                    </div>
                     <hr>
                    <div>
                        <p>T·ªïng s·ªë ng∆∞·ªùi tr√™n xe (Server): <strong id="totalPeopleServer">N/A</strong></p>
                        <p>Ng∆∞·ªùi l·∫° tr√™n xe (Server): <strong id="strangersOnBusServer">N/A</strong></p>
                        <p>S·ª± ki·ªán cu·ªëi t·ª´ server: <em id="lastEventServer">-</em></p>
                    </div>
                </div>
            </div>

            <!-- Tab 2: L·ªãch s·ª≠ (Gi·ªØ nguy√™n) -->
            <div id="history" class="tab-content">
                <div class="history">
                    <h1>L·ªãch s·ª≠ l√™n xu·ªëng</h1>
                    <ul id="historyList" class="history-list"></ul>
                </div>
            </div>

            <!-- Tab 3: Danh s√°ch h·ªçc sinh (Gi·ªØ nguy√™n) -->
            <div id="list" class="tab-content">
                <div class="hoc-sinh">
                    <h1>Danh s√°ch h·ªçc sinh</h1>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                        <i class="bi bi-plus-circle-fill"></i> Th√™m h·ªçc sinh m·ªõi
                    </button>
                </div>
            </div>

            <ul class="nav nav-tabs">
                <li class="active"><a href="#current">Hi·ªán t·∫°i</a></li>
                <li><a href="#history">L·ªãch s·ª≠</a></li>
                <li><a href="#list">Danh s√°ch</a></li>
            </ul>
        </div>
    </div>

    <canvas id="hiddenFrameCanvas"></canvas> <!-- Canvas ·∫©n ƒë·ªÉ l·∫•y frame g·ª≠i ƒëi -->

    <!-- C√°c Modal (Gi·ªØ nguy√™n) -->
    <!-- Modal th√¥ng tin h·ªçc sinh -->
    <div class="modal fade" id="studentModal" tabindex="-1" aria-labelledby="studentModalLabel" aria-hidden="true">
        <!-- N·ªôi dung modal gi·ªØ nguy√™n -->
        <div class="modal-dialog modal-lg">
        <div class="modal-content p-3">
            <div class="modal-header">
            <h5 class="modal-title" id="studentModalLabel">Th√¥ng tin h·ªçc sinh</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
            </div>            <div class="modal-body">
            <div class="row">
                <div class="col-md-4 text-center">
                <img id="studentImage" src="" alt="·∫¢nh h·ªçc sinh" class="img-fluid rounded shadow-sm">
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="changeAvatarBtn">Thay ·∫£nh ƒë·∫°i di·ªán</button>
                    <input type="file" id="avatarFileInput" style="display: none;" accept="image/*">
                </div>
                </div>
                <div class="col-md-8">
                <h5 id="studentName">N/A</h5>
                <p><strong>L·ªõp:</strong> <span id="studentClass">N/A</span></p>
                <p><strong>Tu·ªïi:</strong> <span id="studentAge">N/A</span></p>
                <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="studentAddress">N/A</span></p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                <h6>Th√¥ng tin b·ªë</h6>
                <p><strong>T√™n:</strong> <span id="fatherName">N/A</span></p>
                <p><strong>Tu·ªïi:</strong> <span id="fatherAge">N/A</span></p>
                <p><strong>SƒêT:</strong> <span id="fatherPhone">N/A</span></p>
                </div>
                <div class="col-md-6">
                <h6>Th√¥ng tin m·∫π</h6>
                <p><strong>T√™n:</strong> <span id="motherName">N/A</span></p>
                <p><strong>Tu·ªïi:</strong> <span id="motherAge">N/A</span></p>
                <p><strong>SƒêT:</strong> <span id="motherPhone">N/A</span></p>
                </div>
            </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="editStudentInfoBtn">S·ª≠a th√¥ng tin</button>
            </div>
        </div>
        </div>
    </div>
    <!-- Modal Th√™m th√¥ng tin h·ªçc sinh -->
    <div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
        <!-- N·ªôi dung modal gi·ªØ nguy√™n -->
        <div class="modal-dialog modal-lg">
        <div class="modal-content p-3">
            <div class="modal-header">
            <h5 class="modal-title" id="addStudentModalLabel">Th√™m th√¥ng tin h·ªçc sinh</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
            </div>
            <form id="addStudentForm">            <div class="modal-body">
                <div class="mb-3">
                <label for="inputStudentId" class="form-label">M√£ h·ªçc sinh</label>
                <input type="text" class="form-control" id="inputStudentId" placeholder="Nh·∫≠p m√£ h·ªçc sinh" required>
                </div>
                <div class="mb-3">
                <label for="inputStudentName" class="form-label">H·ªç v√† t√™n</label>
                <input type="text" class="form-control" id="inputStudentName" placeholder="Nh·∫≠p t√™n h·ªçc sinh" required>
                </div>
                <div class="mb-3">
                <label for="inputStudentClass" class="form-label">L·ªõp</label>
                <input type="text" class="form-control" id="inputStudentClass" placeholder="Nh·∫≠p l·ªõp" required>
                </div>
                <div class="mb-3">
                <label for="inputStudentAge" class="form-label">Tu·ªïi</label>
                <input type="number" class="form-control" id="inputStudentAge" placeholder="Nh·∫≠p tu·ªïi" min="1" max="100" required>
                </div>
                <div class="mb-3">
                <label for="inputStudentAddress" class="form-label">ƒê·ªãa ch·ªâ</label>
                <input type="text" class="form-control" id="inputStudentAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ" required>
                </div>                <div class="mb-3">
                <label for="inputStudentImages" class="form-label">·∫¢nh h·ªçc sinh <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="inputStudentImages" accept="image/*" multiple required>
                <div class="form-text text-muted">·∫¢nh ƒë·∫ßu ti√™n s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng l√†m ·∫£nh ƒë·∫°i di·ªán. T·∫£i l√™n nhi·ªÅu ·∫£nh ƒë·ªÉ c·∫£i thi·ªán ƒë·ªô ch√≠nh x√°c nh·∫≠n di·ªán.</div>
                <div id="imagePreviewContainer" class="mt-2 d-flex flex-wrap gap-2"></div>
                </div>
                <hr>
                <h6>Th√¥ng tin b·ªë</h6>
                <div class="mb-3">
                <label for="inputFatherName" class="form-label">T√™n b·ªë</label>
                <input type="text" class="form-control" id="inputFatherName" placeholder="Nh·∫≠p t√™n b·ªë" required>
                </div>
                <div class="mb-3">
                <label for="inputFatherAge" class="form-label">Tu·ªïi b·ªë</label>
                <input type="number" class="form-control" id="inputFatherAge" placeholder="Nh·∫≠p tu·ªïi b·ªë" min="1" max="150" required>
                </div>
                <div class="mb-3">
                <label for="inputFatherPhone" class="form-label">SƒêT b·ªë</label>
                <input type="tel" class="form-control" id="inputFatherPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i b·ªë" required>
                </div>
                <hr>
                <h6>Th√¥ng tin m·∫π</h6>
                <div class="mb-3">
                <label for="inputMotherName" class="form-label">T√™n m·∫π</label>
                <input type="text" class="form-control" id="inputMotherName" placeholder="Nh·∫≠p t√™n m·∫π" required>
                </div>
                <div class="mb-3">
                <label for="inputMotherAge" class="form-label">Tu·ªïi m·∫π</label>
                <input type="number" class="form-control" id="inputMotherAge" placeholder="Nh·∫≠p tu·ªïi m·∫π" min="1" max="150" required>
                </div>
                <div class="mb-3">
                <label for="inputMotherPhone" class="form-label">SƒêT m·∫π</label>
                <input type="tel" class="form-control" id="inputMotherPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i m·∫π" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="submit" class="btn btn-primary">L∆∞u th√¥ng tin</button>
            </div>
            </form>
        </div>
        </div>    </div>
    <!-- Modal Ch·ªânh s·ª≠a th√¥ng tin h·ªçc sinh -->
    <div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
        <!-- N·ªôi dung modal gi·ªØ nguy√™n -->
        <div class="modal-dialog modal-lg">
        <div class="modal-content p-3">
            <div class="modal-header">
            <h5 class="modal-title" id="editStudentModalLabel">Ch·ªânh s·ª≠a th√¥ng tin h·ªçc sinh</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
            </div>
            <form id="editStudentForm">
            <input type="hidden" id="editStudentId">
            <div class="modal-body">
                <div class="mb-3">
                <label for="editStudentName" class="form-label">H·ªç v√† t√™n</label>
                <input type="text" class="form-control" id="editStudentName" placeholder="Nh·∫≠p t√™n h·ªçc sinh" required>
                </div>
                <div class="mb-3">
                <label for="editStudentClass" class="form-label">L·ªõp</label>
                <input type="text" class="form-control" id="editStudentClass" placeholder="Nh·∫≠p l·ªõp" required>
                </div>
                <div class="mb-3">
                <label for="editStudentAge" class="form-label">Tu·ªïi</label>
                <input type="number" class="form-control" id="editStudentAge" placeholder="Nh·∫≠p tu·ªïi" min="1" max="100" required>
                </div>
                <div class="mb-3">
                <label for="editStudentAddress" class="form-label">ƒê·ªãa ch·ªâ</label>
                <input type="text" class="form-control" id="editStudentAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ" required>
                </div>
                <hr>
                <h6>Th√¥ng tin b·ªë</h6>
                <div class="mb-3">
                <label for="editFatherName" class="form-label">T√™n b·ªë</label>
                <input type="text" class="form-control" id="editFatherName" placeholder="Nh·∫≠p t√™n b·ªë" required>
                </div>
                <div class="mb-3">
                <label for="editFatherAge" class="form-label">Tu·ªïi b·ªë</label>
                <input type="number" class="form-control" id="editFatherAge" placeholder="Nh·∫≠p tu·ªïi b·ªë" min="1" max="150" required>
                </div>
                <div class="mb-3">
                <label for="editFatherPhone" class="form-label">SƒêT b·ªë</label>
                <input type="tel" class="form-control" id="editFatherPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i b·ªë" required>
                </div>
                <hr>
                <h6>Th√¥ng tin m·∫π</h6>
                <div class="mb-3">
                <label for="editMotherName" class="form-label">T√™n m·∫π</label>
                <input type="text" class="form-control" id="editMotherName" placeholder="Nh·∫≠p t√™n m·∫π" required>
                </div>
                <div class="mb-3">
                <label for="editMotherAge" class="form-label">Tu·ªïi m·∫π</label>
                <input type="number" class="form-control" id="editMotherAge" placeholder="Nh·∫≠p tu·ªïi m·∫π" min="1" max="150" required>
                </div>
                <div class="mb-3">
                <label for="editMotherPhone" class="form-label">SƒêT m·∫π</label>
                <input type="tel" class="form-control" id="editMotherPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i m·∫π" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
            </div>
            </form>
        </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>